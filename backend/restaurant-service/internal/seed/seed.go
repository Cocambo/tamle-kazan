package seed

import (
	"context"
	"fmt"
	"os"
	"path/filepath"
	"restaurant-service/internal/models"
	"sort"
	"strings"
	"time"

	"gorm.io/gorm"
)

// LoadSeedData загружает начальные данные ресторанов и их фотографий в базу данных.
func LoadSeedData(ctx context.Context, db *gorm.DB, photosDir string) error {
	// Проверяем, есть ли уже рестораны в базе данных
	var count int64
	if err := db.WithContext(ctx).Model(&models.Restaurant{}).Count(&count).Error; err != nil {
		return err
	}
	// Если рестораны уже есть, пропускаем загрузку начальных данных
	if count > 0 {
		return nil
	}

	// Определяем начальные данные ресторанов
	restaurants := []models.Restaurant{
		{
			Name:        "Olio",
			Description: "Уютное итальянское бистро, где современный интерьер сочетается с атмосферой домашней Италии и тёплым, внимательным сервисом. Olio предлагает своим гостям блюда средиземноморской кухни, такие как карбонара с кониной, пышная детройтская пицца, римская пиццетта с бастурмой и халапеньо, а также зеленую пасту с креветками и муссом из пармезана.",
			Address:     "ул. Сибгата Хакима, 51",
			Cuisine:     "Итальянская",
			AverageBill: 1500,
		},
		{
			Name:        "Izakaya Bereg",
			Description: "Паназиатский гастробар с открытой кухней, высоким сервисом и уникальной атмосферой. Izakaya bereg является прекрасной локацией для гастрономических исследователей и поклонников паназиатской кухни.",
			Address:     "ул. Меридианная, 2",
			Cuisine:     "Паназиатская",
			AverageBill: 2000,
		},
		{
			Name:        "Terra et Silva",
			Description: "Ресторан на каждый день. Люди могут приходить к нам несколько раз в неделю на завтраки, обеды и ужины, а не выбираться в заведение только на праздники. При этом к нам можно прийти и в особенные дни.",
			Address:     "ул. Подлужная, 56",
			Cuisine:     "Фьюжн",
			AverageBill: 1600,
		},
		{
			Name:        "Dia",
			Description: "Греческая кухня, изысканные напитки и традиционное битье тарелок - идеальное сочетание для настоящих гедонистов. DIA - место, в которые вы точно будете влюблены!",
			Address:     "ул. Профсоюзная, 10/14",
			Cuisine:     "Греческая",
			AverageBill: 1200,
		},
		{
			Name:        "Cheeseria",
			Description: "Это идеальное место для любителей сыра и изысканной кухни. Здесь вы найдете огромный выбор сыров, каждый из которых представлен в идеальной подаче. Особенно впечатляет сырная карта — консультанты помогут подобрать именно то, что вы ищете.",
			Address:     "ул. Аграрная, 52",
			Cuisine:     "Фьюжн",
			AverageBill: 1500,
		},
		{
			Name:        "Горыныч",
			Description: "Печи, хосперы, смокеры - «ГОРЫНЫЧ» печет и жарит всеми имеющимися способами. В ресторане можно попробовать крафтовый хлеб из собственной пекарни, неаполитанскую пиццу, стейки собственного вызревания.",
			Address:     "ул. Николая Ершова, 62",
			Cuisine:     "Фьюжн",
			AverageBill: 2500,
		},
		{
			Name:        "Грузинские истории",
			Description: "Грузинские Истории - это намного больше, чем грузинский ресторан! Здесь вы ощутите атмосферу грузинского дома, природы и современности, откроете настроение и настоящий вкус национальной кухни. В меню ресторана собраны самые популярные блюда Грузии: пхали и хинкали, хачапури и чашушули, сациви и чкмерули и многие другие.",
			Address:     "ул. Пушкина, 3",
			Cuisine:     "Грузинская",
			AverageBill: 1000,
		},
		{
			Name:        "Реберная",
			Description: "Мясной ресторан с оригинальной концепцией. Гостям выдают бумажные фартуки и слюнявчики с забавными рисунками, а также перчатки, чтобы они могли есть руками. На скатертях можно рисовать фломастерами, пока ждешь свой заказ.",
			Address:     "ул. Баумана, 9",
			Cuisine:     "Фьюжн",
			AverageBill: 1700,
		},
		{
			Name:        "Прана",
			Description: "Пространство осознанной еды и отдыха на берегу Казанки. Здесь завтраки целый день, лёгкие блюда без фритюра и десерты, после которых хочется жить, а не спать.",
			Address:     "ул. Сибгата Хакима, 51",
			Cuisine:     "Фьюжн",
			AverageBill: 1500,
		},
		{
			Name:        "New Asia",
			Description: "Паназиатская кухня в авторском прочтении. Не гонимся за аутентичностью и не следуем рецептурным канонам. Вместо этого создаём впечатляющую еду, в которой неожиданные сочетания и смелые акценты переплетаются с духом и традициями Востока.",
			Address:     "ул. Карла Маркса, 5",
			Cuisine:     "Паназиатская",
			AverageBill: 1650,
		},
		{
			Name:        "Сыроварня",
			Description: "Заведение словно телепортирует тебя в самобытную итальянскую провинцию — с пасторальными открыточными пейзажами, уютными интерьерами в светлых тонах и вкуснейшей итальянской кухней. Ощущение загородного дома также создают высокие потолки, обилие свежей зелени и панорамные окна, в которые льется солнечный свет — с видом на парковые дорожки и тихий пруд.",
			Address:     "ул. Дзержинского, 14А",
			Cuisine:     "Итальянская",
			AverageBill: 2500,
		},
		{
			Name:        "Энием",
			Description: "Уютный семейный ресторан татарской кухни, где традиционные рецепты «маминых» блюд подают в современном интерьере с тёплой домашней атмосферой. В меню коймак из печи, кыстыбый, эчпочмак, токмач и другие национальные блюда.",
			Address:     "ул. Николая Ершова, 62",
			Cuisine:     "Татарская",
			AverageBill: 1800,
		},
		{
			Name:        "Супра",
			Description: "Уютно расположенный ресторан в здании бывшего старого театра, где раньше звучали спектакли и культурные события. Здесь подают классику грузинской кухни: сочные хинкали с мясом и зеленью, хачапури по-аджарски с яйцом и маслом, острый чахохбили из курицы, сациви с грецкими орехами, шашлык из баранины и свежие салаты вроде помидоров с ореховым соусом. Атмосфера гостеприимства дополняется домашним вином и видом на пешеходную улицу.",
			Address:     "ул. Баумана, 58А",
			Cuisine:     "Грузинская",
			AverageBill: 1750,
		},
		{
			Name:        "Гусь",
			Description: "Ресторан расположился в самом сердце Старо-Татарской слободы, а из его окон открывается прекрасный вид на водную гладь озера Кабан. Подают блюда из дровяной печи - гусь, утка, ягненок, и, конечно, пироги!",
			Address:     "ул. Ш. Марджани, 10",
			Cuisine:     "Татарская",
			AverageBill: 1500,
		},
		{
			Name:        "Татар",
			Description: "Ресторан современной татарской кухни, в котором традиционные рецепты оживают в авторском исполнении с элементами фьюжн. В меню классика вроде эчпочмака с наваристым бульоном , салата «Мирас» с тыквой и копчёной уткой, кыстыбыя, мантов и других блюд с акцентом на локальные продукты и семейные традиции.",
			Address:     "ул. Ш. Марджани, 4",
			Cuisine:     "Татарская",
			AverageBill: 1200,
		},
		{
			Name:        "Утка в котелке",
			Description: "Ресторан для ценителей русской, европейской и средиземноморской кухни. Это заведение прекрасно подходит как для деловых обедов, так и для семейных праздников. Светлый зал с камином, живые цветы, белый рояль создают максимально уютную атмосферу для отдыха, а лучшие блюда от шеф-повара делают время, проведённое здесь, по-настоящему необыкновенным.",
			Address:     "ул. Дзержинского, 13",
			Cuisine:     "Фьюжн",
			AverageBill: 3000,
		},
		{
			Name:        "Приют Холостяка",
			Description: "Ресторан европейской и русской кухни, в историческом особняке Казани, где под сводами старины можно позавтракать, пообедать или поужинать в расслабленной атмосфере. В меню стейки, морепродукты, суши, паста и бизнес-ланчи по будням, с акцентом на свежесть и комфортный сервис.",
			Address:     "ул. Чернышевского, 27А",
			Cuisine:     "Фьюжн",
			AverageBill: 2800,
		},
		{
			Name:        "Иtle",
			Description: "Уютный интерьер, выполненный в природных текстурах камня и дерева, создает ощущение домашнего очага для всей семьи. Открытая кухня позволяет наблюдать за приготовлением блюд. Основное меню составляют мясные хиты кухонь стран мира.",
			Address:     "ул. Меридианная, 1",
			Cuisine:     "Фьюжн",
			AverageBill: 1800,
		},
		{
			Name:        "Малабар",
			Description: "Вкусные и полезные блюда от шеф-повара из Индии, аутентичный интерьер с удивительными деталями, атмосфера гармонии, домашний уют и приветливый персонал сделают каждый Ваш визит ярким и запоминающимся событием!",
			Address:     "ул. Малая красная, 13",
			Cuisine:     "Индийская",
			AverageBill: 1500,
		},
		{
			Name:        "Каспийка",
			Description: "Ресторан расположен на набережной озера Кабан, где гостей ждет уютная терраса с прекрасным видом на водную гладь.",
			Address:     "ул. Хади Такташа, 35",
			Cuisine:     "Фьюжн",
			AverageBill: 2000,
		},
	}

	// Читаем папку с изображениями один раз
	entries, err := os.ReadDir(photosDir)
	if err != nil {
		return fmt.Errorf("failed to read photos dir: %w", err)
	}

	// Создаем мапу для хранения фотографий по ресторанам
	// В виде: restaurantIndex -> []photoFileNames
	photosByRestaurant := make(map[int][]string)

	for _, entry := range entries {
		// Пропускаем директории
		if entry.IsDir() {
			continue
		}

		// Получаем имя файла
		name := entry.Name()

		// Фильтруем по расширению
		if !(strings.HasSuffix(name, ".jpg") ||
			strings.HasSuffix(name, ".jpeg") ||
			strings.HasSuffix(name, ".png")) {
			continue
		}

		// вытаскиваем индекс ресторана из имени
		// restaurant_1_0.jpg -> index = 1
		var restaurantIndex int
		if _, err := fmt.Sscanf(name, "restaurant_%d_", &restaurantIndex); err == nil {
			photosByRestaurant[restaurantIndex] = append(
				photosByRestaurant[restaurantIndex],
				name,
			)
		}
	}

	// Загружаем рестораны и их фотографии в базу данных в рамках одной транзакции
	return db.WithContext(ctx).Transaction(func(tx *gorm.DB) error {
		for i := range restaurants {
			restaurant := &restaurants[i]

			// Создаем ресторан в базе данных
			if err := tx.Create(restaurant).Error; err != nil {
				return fmt.Errorf("failed to create restaurant %s: %w", restaurant.Name, err)
			}

			restaurantIndex := i + 1
			photoFiles := photosByRestaurant[restaurantIndex]

			if len(photoFiles) == 0 {
				return fmt.Errorf(
					"no photos found for restaurant %d (%s)",
					restaurantIndex,
					restaurant.Name,
				)
			}

			// Гарантируем стабильный порядок
			sort.Strings(photoFiles)

			// Создаем записи фотографий в базе данных
			for idx, fileName := range photoFiles {
				filePath := filepath.Join(photosDir, fileName)
				if _, err := os.Stat(filePath); err != nil {
					return fmt.Errorf("photo file not found: %s", filePath)
				}

				photo := models.Photo{
					RestaurantID: restaurant.ID,
					URL:          "/api/photos/" + fileName,
					IsMain:       idx == 0, // первая фотография - главная
					CreatedAt:    time.Now(),
				}

				if err := tx.Create(&photo).Error; err != nil {
					return fmt.Errorf("failed to create photo %s: %w", fileName, err)
				}
			}
		}
		return nil
	})
}
